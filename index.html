<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CTP/Obelisk Gambling Simulator</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #111;
      color: #fff;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
    }
    .grid-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    .card-row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .card {
      width: 120px;
      height: 160px;
      perspective: 1000px;
    }
    .inner {
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      position: relative;
    }
    .flipped .inner {
      transform: rotateY(180deg);
    }
    .front, .back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border: 2px solid #333;
      border-radius: 8px;
    }
    .front {
      background: #444;
    }
    .back {
      background: #222;
      transform: rotateY(180deg);
    }
    .back img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    .ctp-glow {
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
      border-radius: 10px;
      z-index: 10;
      pointer-events: none;
      animation: glow 1.5s infinite alternate;
      display: none;
    }
    @keyframes glow {
      from { opacity: 0.7; }
      to { opacity: 1; }
    }
    #result, #history {
      margin: 20px auto;
      max-width: 90%;
    }
    .stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .stat-box {
      background: #222;
      padding: 10px 20px;
      border-radius: 8px;
      min-width: 120px;
    }
    .history-item {
      margin: 5px 0;
      padding: 5px;
      background: #222;
      border-radius: 5px;
    }
    .ctp-highlight {
      color: gold;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>CTP / Obelisk Pull Simulator</h1>
  
  <div class="stats">
    <div class="stat-box">Crystals: <span id="crystal-count">0</span></div>
    <div class="stat-box">Total Pulls: <span id="pull-count">0</span></div>
    <div class="stat-box">Pity: <span id="pity-count">0</span>/100</div>
    <div class="stat-box">CTPs: <span id="ctp-count">0</span></div>
  </div>
  
  <button id="pull-button" onclick="pull(10)">Open 10x (675 Crystals)</button>
  <button onclick="clearHistory()">Clear History</button>

  <div id="result"></div>
  <div id="controls"></div>
  <h2>History</h2>
  <div id="history"></div>

  <script>
    const CRYSTAL_PER_PULL = 67.5;
    const PITY_MAX = 100;
    const crystalDisplay = document.getElementById("crystal-count");
    const pullDisplay = document.getElementById("pull-count");
    const pityDisplay = document.getElementById("pity-count");
    const ctpDisplay = document.getElementById("ctp-count");
    const resultDiv = document.getElementById("result");
    const historyDiv = document.getElementById("history");
    const controlsDiv = document.getElementById("controls");
    const pullButton = document.getElementById("pull-button");
    let recentCTPs = [];
    const MAX_RECENT_CTPS = 2; // How many unique CTPs to remember (2-3 works best)

    const items = [
      { name: "1★ Obelisk", chance: 59.5, img: "https://media.discordapp.net/attachments/1229727479170863146/1377303402438197381/image_2025-05-28_204143326.png?ex=68387940&is=683727c0&hm=38cf9c36abd4a7c70c3980fb3ac0680a10ea6e70b7e87b8d5161555fce2a91d3&=&format=webp&quality=lossless" },
      { name: "2★ Obelisk", chance: 30, img: "https://media.discordapp.net/attachments/1229727479170863146/1377300490877927544/image_2025-05-28_202918363.png?ex=6838768a&is=6837250a&hm=98cd9aaa7eb57706b291eff19eded0aa5df59449a062396dc4db1d633faa879d&=&format=webp&quality=lossless" },
      { name: "3★ Obelisk", chance: 5, img: "https://media.discordapp.net/attachments/1229727479170863146/1377300491133784165/image_2025-05-28_202937443.png?ex=6838768a&is=6837250a&hm=97ba2e86da28a0c24d170fb90497945760ab558226ef570a06f665228898a140&=&format=webp&quality=lossless" },
      { name: "4★ Obelisk", chance: 2.5, img: "https://media.discordapp.net/attachments/1229727479170863146/1377300491418992722/image_2025-05-28_202943180.png?ex=6838768a&is=6837250a&hm=5863f44180ec2944fa0ae01f99114723910055cc7f0746e50e51b949c2b0d465&=&format=webp&quality=lossless" },
      { name: "5★ Obelisk", chance: 1.25, img: "https://media.discordapp.net/attachments/1229727479170863146/1377300491658199061/image_2025-05-28_202955228.png?ex=6838768a&is=6837250a&hm=c0be6b08fe0347008ee296490aaf342d72944fece676425132aa3509076e1881&=&format=webp&quality=lossless" },
      { name: "6★ Obelisk", chance: 0.25, img: "https://media.discordapp.net/attachments/1229727479170863146/1377300491914186812/image_2025-05-28_203002058.png?ex=6838768a&is=6837250a&hm=229d230842eecca9500262ef30d58c3c9951e1518b7d803f64ee15059794a419&=&format=webp&quality=lossless" },
      { name: "CTP Of Authority", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_authority.png" },
      { name: "CTP Of Energy", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_energy.png" },
      { name: "CTP Of Destruction", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_destruction.png" },
      { name: "CTP Of Refinement", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_refinement.png" },
      { name: "CTP Of Regeneration", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_regeneration.png" },
      { name: "CTP Of Rage", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_rage.png" },
      { name: "CTP Of Judgement", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_judgement.png" },
      { name: "CTP Of Greed", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_greed.png" },
      { name: "CTP Of Insight", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_insight.png" },
      { name: "CTP Of Conquest", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_conquest.png" },
      { name: "CTP Of Liberation", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_liberation.png" },
      { name: "CTP Of Patience", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_patience.png" },
      { name: "CTP Of Transcendence", chance: 0.05, img: "https://thanosvibs.money/static/assets/items/ctp_transcendence.png" },
      { name: "CTP Of Veteran", chance: 0.0005, img: "https://thanosvibs.money/static/assets/items/ctp_veteran.png" }
    ];

    let state = {
      crystals: parseInt(localStorage.getItem("crystals")) || 0,
      totalPulls: parseInt(localStorage.getItem("totalPulls")) || 0,
      pityCount: parseInt(localStorage.getItem("pityCount")) || 0,
      ctpsObtained: parseInt(localStorage.getItem("ctpsObtained")) || 0,
      history: JSON.parse(localStorage.getItem("history") || "[]"),
      isPulling: false,
      allCardsRevealed: false
    };

    function updateUI() {
      crystalDisplay.textContent = Math.floor(state.crystals);
      pullDisplay.textContent = state.totalPulls;
      pityDisplay.textContent = state.pityCount;
      ctpDisplay.textContent = state.ctpsObtained;
      pullButton.disabled = state.isPulling && !state.allCardsRevealed;
      
      localStorage.setItem("crystals", state.crystals);
      localStorage.setItem("totalPulls", state.totalPulls);
      localStorage.setItem("pityCount", state.pityCount);
      localStorage.setItem("ctpsObtained", state.ctpsObtained);
      localStorage.setItem("history", JSON.stringify(state.history));
      
      updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
      historyDiv.innerHTML = state.history.map(entry => {
        if (entry.startsWith(">>>")) {
          return `<div class="history-item ctp-highlight">${entry}</div>`;
        } else {
          return `<div class="history-item">${entry}</div>`;
        }
      }).join("");
    }

    function getRandomItem() {
  // Filter out recently dropped CTPs
  let eligibleItems = items.filter(item => {
    if (!item.name.includes("CTP")) return true;
    return !recentCTPs.includes(item.name);
  });
  
  // If all CTPs are in recent memory, allow any
  if (eligibleItems.length === 0) eligibleItems = [...items];

  // Standard probability calculation
  const rand = Math.random() * 100;
  let sum = 0;
  
  for (const item of eligibleItems) {
    sum += item.chance;
    if (rand <= sum) {
      // Track CTP drops
      if (item.name.includes("CTP")) {
        recentCTPs.push(item.name);
        if (recentCTPs.length > MAX_RECENT_CTPS) {
          recentCTPs.shift(); // Remove oldest entry
        }
      }
      return item;
    }
  }
  return items[0]; // Fallback
}

    function pull(count) {
      recentCTPs = [];
      if (state.isPulling && !state.allCardsRevealed) return;
      
      state.isPulling = true;
      state.allCardsRevealed = false;
      updateUI();
      
      let pulls = [];
      let gotCTP = false;
      let pullsSinceLastCTP = state.pityCount;

      for (let i = 0; i < count; i++) {
        state.totalPulls++;
        pullsSinceLastCTP++;
        
        if (pullsSinceLastCTP >= PITY_MAX && !gotCTP) {
          const ctpItem = items.find(item => item.name.includes("CTP"));
          pulls.push(ctpItem);
          state.ctpsObtained++;
          gotCTP = true;
          pullsSinceLastCTP = 0;
          continue;
        }
        
        const item = getRandomItem();
        pulls.push(item);
        
        if (item.name.includes("CTP")) {
          state.ctpsObtained++;
          gotCTP = true;
          pullsSinceLastCTP = 0;
        }
      }

      state.pityCount = gotCTP ? 0 : pullsSinceLastCTP;
      state.crystals += CRYSTAL_PER_PULL * count;
      
      // Create two rows of 5 cards each
      const topRow = pulls.slice(0, 5);
      const bottomRow = pulls.slice(5, 10);
      
      resultDiv.innerHTML = `
        <div class="grid-container">
          <div class="card-row" id="top-row"></div>
          <div class="card-row" id="bottom-row"></div>
        </div>
      `;
      
      // Add cards to rows
      topRow.forEach((item, i) => {
        document.getElementById("top-row").innerHTML += `
          <div class="card" id="card-${i}">
            <div class="inner">
              <div class="front"></div>
              <div class="back">
                <img src="${item.img}" alt="${item.name}">
              </div>
            </div>
            ${item.name.includes("CTP") ? '<div class="ctp-glow"></div>' : ''}
          </div>
        `;
      });
      
      bottomRow.forEach((item, i) => {
        document.getElementById("bottom-row").innerHTML += `
          <div class="card" id="card-${i+5}">
            <div class="inner">
              <div class="front"></div>
              <div class="back">
                <img src="${item.img}" alt="${item.name}">
              </div>
            </div>
            ${item.name.includes("CTP") ? '<div class="ctp-glow"></div>' : ''}
          </div>
        `;
      });

      controlsDiv.innerHTML = `
        <button onclick="skipReveal()">Skip Reveal</button>
        <button onclick="closeResult()" id="close-btn">Close</button>
      `;

      // Flip cards one by one with delay
      let currentCard = 0;
      const flipInterval = setInterval(() => {
        const card = document.getElementById(`card-${currentCard}`);
        if (card) {
          card.classList.add("flipped");
          const glow = card.querySelector('.ctp-glow');
          if (glow) {
            setTimeout(() => glow.style.display = 'block', 300);
          }
        }
        currentCard++;
        if (currentCard >= pulls.length) {
          clearInterval(flipInterval);
          state.allCardsRevealed = true;
          updateUI();
        }
      }, 300);

      // Update history
      state.history.push(`Pulls ${state.totalPulls-count+1}-${state.totalPulls}: ${formatHistoryEntry(pulls)}`);
      if (gotCTP) {
        const ctpCount = pulls.filter(p => p.name.includes("CTP")).length;
        state.history.push(`>>> Obtained ${ctpCount} CTP(s)!`);
      }
      
      updateUI();
    }

function formatHistoryEntry(pulls) {
  const grouped = {};
  pulls.forEach(item => {
    grouped[item.name] = (grouped[item.name] || 0) + 1;
  });
  return Object.entries(grouped).map(([name, count]) => 
    count > 1 ? `${name} ×${count}` : name
  ).join(", ");
}

    function skipReveal() {
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        if (!card.classList.contains("flipped")) {
          card.classList.add("flipped");
          const glow = card.querySelector('.ctp-glow');
          if (glow) glow.style.display = 'block';
        }
      });
      state.allCardsRevealed = true;
      updateUI();
    }

    function closeResult() {
      resultDiv.innerHTML = "";
      controlsDiv.innerHTML = "";
      state.isPulling = false;
      state.allCardsRevealed = false;
      updateUI();
    }

    function clearHistory() {
      if (confirm("Clear all history and statistics?")) {
        state = {
          crystals: 0,
          totalPulls: 0,
          pityCount: 0,
          ctpsObtained: 0,
          history: [],
          isPulling: false,
          allCardsRevealed: false
        };
        localStorage.clear();
        updateUI();
        resultDiv.innerHTML = "";
        controlsDiv.innerHTML = "";
      }
    }

    updateUI();
  </script>
</body>
</html>
